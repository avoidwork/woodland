/*!
 2022 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 17.0.1
*/
import{STATUS_CODES,METHODS}from"node:http";import{join,extname,resolve}from"node:path";import{EventEmitter}from"node:events";import{readFileSync,createReadStream,stat,readdir}from"node:fs";import{etag}from"tiny-etag";import{precise}from"precise";import{lru}from"tiny-lru";import{fileURLToPath,URL}from"node:url";import{coerce}from"tiny-coerce";import mimeDb from"mime-db";const all="*",delimiter="|",levels={emerg:0,alert:1,crit:2,error:3,warn:4,notice:5,info:6,debug:7},months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],__dirname=fileURLToPath(new URL(".",import.meta.url)),html=readFileSync(join(__dirname,"..","tpl","autoindex.html"),{encoding:"utf8"}),valid=Object.entries(mimeDb).filter((e=>"extensions"in e[1])),extensions=valid.reduce(((e,t)=>{const s=Object.assign({type:t[0]},t[1]);for(const t of s.extensions)e[`.${t}`]=s;return e}),{});function autoindex(title="",files=[]){return eval("`"+html+"`")}function clone(e){return JSON.parse(JSON.stringify(e))}function last(e,t,s,r){const i=t.statusCode||0;return void 0===r?s(new Error(e.allow.length>0?"GET"!==e.method?405:e.allow.includes("GET")?500:404:404)):!1===isNaN(i)&&i>=400?s(r):s(new Error(i>=400?i:!1===isNaN(r.message)?r.message:STATUS_CODES[r.message||r]||500)),!0}function mime(e=""){const t=extname(e);return t in extensions?extensions[t].type:"application/octet-stream"}function ms(e=0,t=3){return`${Number(e/1e6).toFixed(t)} ms`}function next(e,t,s,r){const i=a=>process.nextTick((()=>{let o=r.next();if(!1===o.done)if(void 0!==a){for(;!1===o.done&&o.value.length<4;)o=r.next();!1===o.done?o.value(a,e,t,i):last(e,t,s,a)}else o.value(e,t,i);else last(e,t,s,a)}));return i}function pad(e=0){return String(e).padStart(2,"0")}function params(e,t=[]){if(t.length>0){const s=e.parsed.pathname.split("/");for(const r of t)e.params[r[1]]=coerce(decodeURIComponent(s[r[0]]))}}function parse(e){return new URL("string"==typeof e?e:`http://${e.headers.host||`localhost:${e.socket.server._connectionKey.replace(/.*::/,"")}`}${e.url}`)}function partial(e,t,s,r,i){if(0===(e.headers.range||"").indexOf("bytes=")){const r={},a=Buffer.byteLength(s);for(const[t,s]of e.headers.range.replace("bytes=","").split(",")[0].split("-").entries())r[0===t?"start":"end"]=s?parseInt(s,10):void 0;isNaN(r.start)&&!1===isNaN(r.end)?(r.start=a-r.end,r.end=a):isNaN(r.end)&&(r.end=a),!1===(r.start>=r.end||isNaN(r.start)||isNaN(r.end))&&(e.range=r,i["content-range"]=`bytes ${r.start+(r.end===a?1:0)}-${r.end}/${a}`,i["content-length"]=""+(r.end-r.start+(r.end===a?0:1)),t.statusCode=206,t.removeHeader("etag"),delete i.etag)}}function pipeable(e,t){return"HEAD"!==e&&null!==t&&"function"==typeof t.on}function reduce(e,t=new Map,s={},r=!1,i=new Set){Array.from(t.entries()).filter((t=>(t[0].lastIndex=0,t[0].test(e)))).forEach((e=>{for(const t of e[1].handlers)s.middleware.push(t),r&&null===s.last&&!1===i.has(t)&&(s.last=t);e[1].pos.length>0&&0===s.pos.length&&(s.pos=e[1].pos,s.params=e[1].params)}))}function stream(e,t,s={charset:"",etag:"",path:"",stats:{mtime:new Date,size:0}}){if(t.header("content-length",s.stats.size),t.header("content-type",s.charset.length>0?`${mime(s.path)}; charset=${s.charset}`:mime(s.path)),t.header("last-modified",s.stats.mtime.toUTCString()),s.etag.length>0&&(t.header("etag",s.etag),t.removeHeader("cache-control")),"GET"===e.method)if(s.etag.length>0&&e.headers["if-none-match"]===s.etag||void 0===e.headers["if-none-match"]&&Date.parse(e.headers["if-modified-since"])>=s.stats.mtime)t.removeHeader("content-type"),t.removeHeader("content-length"),t.send("",304);else{const r={};let i=200;if("range"in e.headers){const a=e.headers.range.replace(/^.*=/,"").split(",")[0].split("-");for(const[e,t]of a.entries())r[0===e?"start":"end"]=void 0!==t?parseInt(t,10):void 0;isNaN(r.start)&&!1===isNaN(r.end)?(r.start=s.stats.size-r.end,r.end=s.stats.size):isNaN(r.end)&&(r.end=s.stats.size),(r.start>=r.end||isNaN(r.start)||isNaN(r.end))&&t.error(416),i=206,t.removeHeader("content-length"),t.removeHeader("etag"),t.header("content-range",`bytes ${r.start}-${r.end}/${s.stats.size}`),t.header("content-length",r.end-r.start+1)}t.send(createReadStream(s.path,r),i)}else"HEAD"===e.method?t.send(""):"OPTIONS"===e.method?(t.removeHeader("content-length"),t.send("Make a GET request to retrieve the file")):t.error(405)}function timeOffset(e=0){const t=e<0;return`${t?"":"-"}${String((t?-e:e)/60).split(".").reduce(((e,t,s,r)=>(e.push(0===s?pad(t):"30"),1===r.length&&e.push("00"),e)),[]).join("")}`}function writeHead(e,t,s){e.statusCode<t&&(e.statusCode=t),e.writeHead(e.statusCode,STATUS_CODES[e.statusCode],s)}class Woodland extends EventEmitter{constructor({autoindex:e=!1,cacheSize:t=1e3,cacheTTL:s=3e5,charset:r="utf-8",defaultHeaders:i={},digit:a=3,etags:o=!0,indexes:n=["index.htm","index.html"],logging:d={},origins:l=["*"],seed:h=42,sendError:c=!1,time:g=!1}={}){super(),this.autoindex=e,this.ignored=new Set,this.cache=lru(t,s),this.charset=r,this.corsExpose="",this.defaultHeaders=Object.keys(i).map((e=>[e.toLowerCase(),i[e]])),this.digit=a,this.etags=o?etag({cacheSize:t,cacheTTL:s,seed:h}):null,this.indexes=JSON.parse(JSON.stringify(n)),this.permissions=lru(t,s),this.logging={enabled:!1!==d.enabled,format:d.format||'%h %l %u %t "%r" %>s %b',level:d.level||"info"},this.methods=[],this.middleware=new Map,this.origins=JSON.parse(JSON.stringify(l)),this.sendError=c,this.time=g,null!==this.etags&&this.get(this.etags.middleware).ignore(this.etags.middleware)}allowed(e,t,s=!1){return this.routes(t,e,s).visible>0}allows(e,t=!1){let s=!1===t?this.permissions.get(e):void 0;if(t||void 0===s){const r=this.routes(e,all,t).visible>0?clone(METHODS):this.methods.filter((s=>this.allowed(s,e,t)));r.includes("GET")&&(!1===r.includes("HEAD")&&r.push("HEAD"),!1===r.includes("OPTIONS")&&r.push("OPTIONS")),s=r.sort().join(", "),this.permissions.set(e,s)}return this.logging.enabled&&this.log(`type=allows, uri=${e}, override=${t}, message="Determined 'allow' header value"`,"debug"),s}always(...e){return this.use(...e,all)}connect(...e){return this.use(...e,"CONNECT")}clf(e,t){const s=new Date;return this.logging.format.replace("%v",e.headers.host).replace("%h",e.ip||"-").replace("%l","-").replace("%u",e.parsed.username||"-").replace("%t",`[${s.getDate()}/${months[s.getMonth()]}/${s.getFullYear()}:${pad(s.getHours())}:${pad(s.getMinutes())}:${pad(s.getSeconds())} ${timeOffset(s.getTimezoneOffset())}]`).replace("%r",`${e.method} ${e.parsed.pathname}${e.parsed.search} HTTP/1.1`).replace("%>s",t.statusCode).replace("%b",t.getHeader("content-length")||"-").replace("%{Referer}i",e.headers.referer||"-").replace("%{User-agent}i",e.headers["user-agent"]||"-")}decorate(e,t){this.time&&(e.precise=precise().start());const s=parse(e);e.parsed=s,e.allow=this.allows(s.pathname),e.body="",e.corsHost="origin"in e.headers&&e.headers.origin.replace(/^http(s)?:\/\//,"")!==e.headers.host,e.cors=e.corsHost&&(this.origins.includes(all)||this.origins.includes(e.headers.origin)),e.host=s.hostname,e.ip="x-forwarded-for"in e.headers?e.headers["x-forwarded-for"].split(",").pop().trim():e.connection.remoteAddress,t.locals={},e.params={},t.error=(s=500,r)=>{const i=void 0!==r?r instanceof Error?r:new Error(r):new Error(STATUS_CODES[s]);t.statusCode=s,this.logging.enabled&&this.log(`type=res.error, status=${s}, ip=${e.ip}, uri=${e.parsed.pathname}, message="Routing to error handler"`,"debug"),this.error(e,t,i)},t.header=t.setHeader,t.json=(e,s=200,r={"content-type":"application/json; charset=utf-8"})=>t.send(JSON.stringify(e),s,r),t.redirect=(e,s=!0)=>t.send("",s?301:302,{location:e}),t.send=(s="",r=200,i={})=>{if(!1===t.headersSent){if([s,r,i]=this.onsend(e,t,s,r,i),this.time&&void 0===t.getHeader("x-response-time")&&t.header("x-response-time",`${ms(e.precise.stop().diff(),this.digit)}`),pipeable(e.method,s))writeHead(t,r,i),s.on("error",(()=>{})).pipe(t);else if("string"!=typeof s&&"toString"in s&&(s=s.toString()),void 0!==e.headers.range){const a=Buffer.from(s);partial(e,t,a,r,i),void 0!==e.range?(writeHead(t,r,i),t.end(a.slice(e.range.start,e.range.end+1).toString(),this.charset)):(delete e.headers.range,t.error(416))}else{const e="content-length";void 0===t.getHeader(e)&&t.header(e,Buffer.byteLength(s)),writeHead(t,r,i),t.end(s,this.charset)}this.logging.enabled&&(this.log(`type=res.send, uri=${e.parsed.pathname}, ip=${e.ip}, valid=true, message="Sending response body"`,"debug"),this.log(this.clf(e,t),"info"))}else this.logging.enabled&&this.log(`type=res.send, uri=${e.parsed.pathname}, ip=${e.ip}, valid=false, message="Headers already sent"`,"debug")},t.status=e=>(t.statusCode=e,t);for(const e of this.defaultHeaders)t.header(e[0],e[1]);if(t.header("allow",e.allow),e.cors){const s=e.headers["access-control-request-headers"]||this.corsExpose;t.header("access-control-allow-origin",e.headers.origin),t.header("timing-allow-origin",e.headers.origin),t.header("access-control-allow-credentials","true"),void 0!==s&&t.header(`access-control-${"OPTIONS"===e.method?"allow":"expose"}-headers`,s),t.header("access-control-allow-methods",e.allow)}this.logging.enabled&&this.log(`type=decorate, uri=${e.parsed.pathname}, method=${e.method}, ip=${e.ip}, message="Decorated request from ${e.ip}"`,"debug")}del(...e){return this.use(...e,"DELETE")}delete(...e){return this.use(...e,"DELETE")}error(e,t,s){const r="error";if(!1===t.headersSent){const r=!1===isNaN(s.message),i=!1===isNaN(t.statusCode)&&t.statusCode>=400?t.statusCode:r?Number(s.message):500,a=!1===this.sendError?r?STATUS_CODES[i]:s.message:s;404===i&&(t.removeHeader("allow"),t.header("allow",""),e.cors&&(t.removeHeader("access-control-allow-methods"),t.header("access-control-allow-methods",e.allow))),r&&this.sendError&&(a.message=STATUS_CODES[i]),t.statusCode=i,t.send(a,i)}this.listenerCount(r)>0&&this.emit(r,e,t,s),this.logging.enabled&&this.log(`type=error, message="Handled error response for ${e.ip}"`,"debug")}etag(e,...t){return"GET"!==e&&"HEAD"!==e&&"OPTIONS"!==e||null===this.etags?"":this.etags.create(t.map((e=>"string"!=typeof e?JSON.stringify(e).replace(/^"|"$/g,""):e)).join("-"))}get(...e){return this.use(...e,"GET")}ignore(e){return this.ignored.add(e),this.logging.enabled&&this.log(`type=ignore, message="Added function to ignored Set", code="${e.toString()}"`,"debug"),this}list(e="get",t="array"){let s;if("array"===t)s=Array.from(this.middleware.get(e.toUpperCase()).keys());else if("object"===t){s={};for(const[t,r]of this.middleware.get(e.toUpperCase()).entries())s[t]=r}return this.logging.enabled&&this.log(`type=list, method=${e}, type=${t}`,"debug"),s}log(e,t="debug"){const s=levels[t];return s<=levels[this.logging.level]&&process.nextTick((()=>console[s>4?"log":"error"](e))),this}onsend(e,t,s,r,i){return[s,r,i]}options(...e){return this.use(...e,"OPTIONS")}patch(...e){return this.use(...e,"PATCH")}path(e=""){return e.replace(/\/:([^/]+)/g,"/([^/]+)")}post(...e){return this.use(...e,"POST")}put(...e){return this.use(...e,"PUT")}route(e,t){const s=e=>t.error(t.statusCode,e),r="connect",i="finish";let a="HEAD"===e.method?"GET":e.method;if(this.decorate(e,t),this.listenerCount(r)>0&&this.emit(r,e,t),this.listenerCount(i)>0&&t.on(i,(()=>this.emit(i,e,t))),"OPTIONS"===a&&!1===this.allowed(a,e.parsed.pathname)&&(a="GET"),!1===e.cors&&"origin"in e.headers&&e.corsHost&&!1===this.origins.includes(e.headers.origin))t.error(403);else if(e.allow.includes(a)){const r=this.routes(e.parsed.pathname,a);r.params&&params(e,r.pos),e.last=r.last,next(e,t,s,r.middleware[Symbol.iterator]())()}else last(e,t,s);this.logging.enabled&&this.log('type=route, message="Routing request"',"debug")}routes(e,t,s=!1){const r=`${t}${delimiter}${e}`,i=!1===s?this.cache.get(r):void 0;let a;return void 0!==i?a=i:(a={middleware:[],params:!1,pos:[],visible:0,last:null},reduce(e,this.middleware.get(all),a),t!==all&&reduce(e,this.middleware.get(t),a,!0,this.ignored),a.visible=a.middleware.filter((e=>!1===this.ignored.has(e))).length,this.cache.set(r,a)),this.logging.enabled&&this.log(`type=routes, uri=${e}, method=${t}, cached=${void 0!==i}, middleware=${a.middleware.length}, params=${a.params}, visible=${a.visible}, override=${s}, message="Retrieved middleware for request"`,"debug"),a}serve(e,t,s="",r=process.cwd(),i=this.indexes){const a=resolve(r,decodeURIComponent(s));"GET"!==e.method&&"HEAD"!==e.method&&"OPTIONS"!==e.method?(e.allow.length>0&&(e.allow="GET, HEAD, OPTIONS",t.header("allow",e.allow)),t.error(405)):stat(a,{bigint:!1},((s,r)=>{null!==s?t.error(404):!1===r.isDirectory()?stream(e,t,{charset:this.charset,etag:this.etag(e.method,r.ino,r.size,r.mtimeMs),path:a,stats:r}):!1===e.parsed.pathname.endsWith("/")?t.redirect(`${e.parsed.pathname}/${e.parsed.search}`):readdir(a,{encoding:"utf8",withFileTypes:!0},((s,r)=>{if(null!==s)t.error(500,s);else{let s="";for(const e of r)if(i.includes(e.name)){s=join(a,e.name);break}if(0===s.length)if(!1===this.autoindex)t.error(404);else{let s,i=!0,a="";try{a=autoindex(decodeURIComponent(e.parsed.pathname),r)}catch(e){i=!1,s=e}i?(t.header("content-type",`text/html; charset=${this.charset}`),t.send(a)):t.error(500,s)}else stat(s,{bigint:!1},((r,i)=>{null!==r?t.error(500,r):stream(e,t,{charset:this.charset,etag:this.etag(e.method,i.ino,i.size,i.mtimeMs),path:s,stats:i})}))}}))})),this.logging.enabled&&this.log(`type=serve, uri=${e.parsed.pathname}, method=${e.method}, message="Routing request to file system"`,"debug")}trace(...e){return this.use(...e,"TRACE")}use(e,...t){"function"==typeof e&&(t=[e,...t],e=`/.${all}`);const s="string"==typeof t[t.length-1]?t.pop().toUpperCase():"GET";if(s!==all&&!1===METHODS.includes(s))throw new TypeError("Invalid HTTP method");if("HEAD"===s)throw new TypeError("Cannot set HEAD route, use GET");!1===this.middleware.has(s)&&(s!==all&&this.methods.push(s),this.middleware.set(s,new Map));const r=this.middleware.get(s),i=[];let a=e,o=!1;if(a.includes(":")&&!1===a.includes("(")){o=!0;for(const[e,t]of a.split("/").entries())":"===t[0]&&i.push([e,t.replace(/^:/,"")]);a=this.path(a)}const n=r.get(a)||{},d=(n.pos||[]).length>0;return a=new RegExp(`^${a}$`),r.set(a,{handlers:[...n.handlers||[],...t],params:d?n.params:o,pos:d?n.pos:i}),this.logging.enabled&&this.log(`type=use, route=${e}, method=${s}, message="Registering middleware"`,"debug"),this}}function woodland(e){const t=new Woodland(e);return t.route=t.route.bind(t),t}export{woodland};//# sourceMappingURL=woodland.esm.min.js.map
